<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MemGresTestExecutionListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MemGres Core</a> &gt; <a href="index.source.html" class="el_package">com.memgres.testing.spring</a> &gt; <span class="el_source">MemGresTestExecutionListener.java</span></div><h1>MemGresTestExecutionListener.java</h1><pre class="source lang-java linenums">package com.memgres.testing.spring;

import com.memgres.core.MemGresEngine;
import com.memgres.sql.execution.SqlExecutionEngine;
import com.memgres.testing.MemGresTestDataSource;
import com.memgres.testing.MemGresTestHelper;
import com.memgres.transaction.Transaction;
import com.memgres.transaction.TransactionIsolationLevel;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.Ordered;
import org.springframework.test.context.TestContext;
import org.springframework.test.context.TestExecutionListener;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;

import javax.sql.DataSource;

/**
 * Spring TestExecutionListener for MemGres database integration.
 * 
 * &lt;p&gt;This listener automatically manages the lifecycle of MemGres database instances
 * for tests annotated with {@link DataMemGres}. It provides:&lt;/p&gt;
 * &lt;ul&gt;
 *   &lt;li&gt;Automatic database startup and shutdown&lt;/li&gt;
 *   &lt;li&gt;Spring ApplicationContext integration&lt;/li&gt;
 *   &lt;li&gt;DataSource bean registration and injection&lt;/li&gt;
 *   &lt;li&gt;Schema creation and initialization&lt;/li&gt;
 *   &lt;li&gt;SQL script execution&lt;/li&gt;
 *   &lt;li&gt;Transaction management with rollback support&lt;/li&gt;
 *   &lt;li&gt;Test isolation&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt;The listener runs with a higher precedence than the default 
 * {@link DependencyInjectionTestExecutionListener} to ensure the MemGres 
 * database is available for dependency injection.&lt;/p&gt;
 * 
 * @since 1.0.0
 */
<span class="fc" id="L39">public class MemGresTestExecutionListener implements TestExecutionListener, Ordered {</span>
    
<span class="fc" id="L41">    private static final Logger logger = LoggerFactory.getLogger(MemGresTestExecutionListener.class);</span>
    
    private static final String ENGINE_ATTR = &quot;memgres.engine&quot;;
    private static final String TRANSACTION_ATTR = &quot;memgres.transaction&quot;;
    private static final String CONFIG_ATTR = &quot;memgres.config&quot;;
    private static final String HELPER_ATTR = &quot;memgres.helper&quot;;
    private static final String DATASOURCE_ATTR = &quot;memgres.datasource&quot;;
    
    // Run before DependencyInjectionTestExecutionListener to ensure DataSource is available
<span class="fc" id="L50">    private static final int ORDER = DependencyInjectionTestExecutionListener.class</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">            .getAnnotation(org.springframework.core.annotation.Order.class) != null ?</span>
<span class="nc" id="L52">            DependencyInjectionTestExecutionListener.class.getAnnotation(org.springframework.core.annotation.Order.class).value() - 100 :</span>
<span class="fc" id="L53">            2000;</span>
    
    @Override
    public int getOrder() {
<span class="fc" id="L57">        return ORDER;</span>
    }
    
    @Override
    public void beforeTestClass(TestContext testContext) throws Exception {
<span class="fc" id="L62">        DataMemGres annotation = findDataMemGresAnnotation(testContext);</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if (annotation == null) {</span>
<span class="nc" id="L64">            return;</span>
        }
        
<span class="fc" id="L67">        logger.debug(&quot;Setting up MemGres database for test class: {}&quot;, testContext.getTestClass().getName());</span>
        
<span class="fc" id="L69">        MemGresTestHelper helper = new MemGresTestHelper();</span>
<span class="fc" id="L70">        MemGresTestHelper.MemGresConfig config = createConfig(annotation);</span>
<span class="fc" id="L71">        MemGresEngine engine = helper.createEngine(config);</span>
        
        // Create DataSource
<span class="fc" id="L74">        MemGresTestDataSource dataSource = new MemGresTestDataSource(engine);</span>
        
        // Store in test context
<span class="fc" id="L77">        testContext.setAttribute(ENGINE_ATTR, engine);</span>
<span class="fc" id="L78">        testContext.setAttribute(CONFIG_ATTR, config);</span>
<span class="fc" id="L79">        testContext.setAttribute(HELPER_ATTR, helper);</span>
<span class="fc" id="L80">        testContext.setAttribute(DATASOURCE_ATTR, dataSource);</span>
        
        // Register DataSource in Spring ApplicationContext
<span class="fc" id="L83">        registerDataSourceInContext(testContext, annotation, dataSource);</span>
        
<span class="fc" id="L85">        logger.info(&quot;MemGres database ready for test class: {}&quot;, testContext.getTestClass().getName());</span>
<span class="fc" id="L86">    }</span>
    
    @Override
    public void afterTestClass(TestContext testContext) throws Exception {
<span class="fc" id="L90">        MemGresEngine engine = (MemGresEngine) testContext.getAttribute(ENGINE_ATTR);</span>
<span class="fc" id="L91">        MemGresTestHelper helper = (MemGresTestHelper) testContext.getAttribute(HELPER_ATTR);</span>
        
<span class="pc bpc" id="L93" title="2 of 4 branches missed.">        if (engine != null &amp;&amp; helper != null) {</span>
<span class="fc" id="L94">            logger.debug(&quot;Shutting down MemGres database for test class: {}&quot;, testContext.getTestClass().getName());</span>
<span class="fc" id="L95">            helper.shutdownEngine(engine);</span>
<span class="fc" id="L96">            logger.info(&quot;MemGres database shutdown complete for test class: {}&quot;, testContext.getTestClass().getName());</span>
        }
        
        // Clean up attributes
<span class="fc" id="L100">        testContext.removeAttribute(ENGINE_ATTR);</span>
<span class="fc" id="L101">        testContext.removeAttribute(CONFIG_ATTR);</span>
<span class="fc" id="L102">        testContext.removeAttribute(HELPER_ATTR);</span>
<span class="fc" id="L103">        testContext.removeAttribute(DATASOURCE_ATTR);</span>
<span class="fc" id="L104">        testContext.removeAttribute(TRANSACTION_ATTR);</span>
<span class="fc" id="L105">    }</span>
    
    @Override
    public void beforeTestMethod(TestContext testContext) throws Exception {
<span class="fc" id="L109">        DataMemGres annotation = findDataMemGresAnnotation(testContext);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (annotation == null) {</span>
<span class="nc" id="L111">            return;</span>
        }
        
<span class="fc" id="L114">        MemGresEngine engine = (MemGresEngine) testContext.getAttribute(ENGINE_ATTR);</span>
<span class="fc" id="L115">        MemGresTestHelper.MemGresConfig config = (MemGresTestHelper.MemGresConfig) testContext.getAttribute(CONFIG_ATTR);</span>
        
<span class="pc bpc" id="L117" title="2 of 4 branches missed.">        if (engine == null || config == null) {</span>
<span class="nc" id="L118">            throw new IllegalStateException(&quot;MemGres engine not initialized. Ensure @DataMemGres annotation is present at class level.&quot;);</span>
        }
        
        // Start transaction for all test methods to maintain data consistency
        // For non-transactional tests, this ensures INSERT/SELECT operations see each other's data
        // For transactional tests, this will be rolled back after the test
<span class="fc" id="L124">        Transaction transaction = engine.getTransactionManager()</span>
<span class="fc" id="L125">                .beginTransaction(TransactionIsolationLevel.READ_COMMITTED);</span>
<span class="fc" id="L126">        testContext.setAttribute(TRANSACTION_ATTR, transaction);</span>
        
        // Set the transaction in the thread-local context so SqlExecutionEngine can use it
<span class="fc" id="L129">        engine.getTransactionManager().setCurrentTransaction(transaction);</span>
        
<span class="fc" id="L131">        logger.debug(&quot;Started transaction for test method: {} (transactional={})&quot;, </span>
<span class="fc" id="L132">                    testContext.getTestMethod().getName(), config.isTransactional());</span>
<span class="fc" id="L133">    }</span>
    
    @Override
    public void afterTestMethod(TestContext testContext) throws Exception {
<span class="fc" id="L137">        DataMemGres annotation = findDataMemGresAnnotation(testContext);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (annotation == null) {</span>
<span class="nc" id="L139">            return;</span>
        }
        
<span class="fc" id="L142">        MemGresEngine engine = (MemGresEngine) testContext.getAttribute(ENGINE_ATTR);</span>
<span class="fc" id="L143">        MemGresTestHelper helper = (MemGresTestHelper) testContext.getAttribute(HELPER_ATTR);</span>
<span class="fc" id="L144">        MemGresTestHelper.MemGresConfig config = (MemGresTestHelper.MemGresConfig) testContext.getAttribute(CONFIG_ATTR);</span>
<span class="fc" id="L145">        Transaction transaction = (Transaction) testContext.getAttribute(TRANSACTION_ATTR);</span>
        
        // Handle transaction cleanup
<span class="pc bpc" id="L148" title="4 of 8 branches missed.">        if (helper != null &amp;&amp; config != null &amp;&amp; transaction != null &amp;&amp; engine != null) {</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            if (config.isTransactional()) {</span>
                // For transactional tests, rollback to undo changes
<span class="nc" id="L151">                helper.rollbackTransactionIfNeeded(engine, transaction, config);</span>
<span class="nc" id="L152">                logger.debug(&quot;Rolled back transaction for transactional test method: {}&quot;, testContext.getTestMethod().getName());</span>
            } else {
                // For non-transactional tests, commit the changes
<span class="fc" id="L155">                engine.getTransactionManager().commitTransaction(transaction);</span>
<span class="fc" id="L156">                logger.debug(&quot;Committed transaction for non-transactional test method: {}&quot;, testContext.getTestMethod().getName());</span>
            }
            
            // Clear the transaction context
<span class="fc" id="L160">            engine.getTransactionManager().setCurrentTransaction(null);</span>
<span class="fc" id="L161">            testContext.removeAttribute(TRANSACTION_ATTR);</span>
        }
<span class="fc" id="L163">    }</span>
    
    private DataMemGres findDataMemGresAnnotation(TestContext testContext) {
<span class="fc" id="L166">        return testContext.getTestClass().getAnnotation(DataMemGres.class);</span>
    }
    
    private MemGresTestHelper.MemGresConfig createConfig(DataMemGres annotation) {
<span class="fc" id="L170">        return new MemGresTestHelper.MemGresConfig(</span>
<span class="fc" id="L171">            annotation.schema(),</span>
<span class="fc" id="L172">            annotation.autoCreateTables(),</span>
<span class="fc" id="L173">            annotation.initScripts(),</span>
<span class="fc" id="L174">            annotation.transactional(),</span>
<span class="fc" id="L175">            annotation.startupTimeoutMs()</span>
        );
    }
    
    private void registerDataSourceInContext(TestContext testContext, DataMemGres annotation, DataSource dataSource) {
        // Register the DataSource in the ApplicationContext using Spring's test context framework
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (testContext.getApplicationContext() instanceof </span>
            org.springframework.context.support.GenericApplicationContext) {
            
<span class="fc" id="L184">            org.springframework.context.support.GenericApplicationContext context = </span>
<span class="fc" id="L185">                (org.springframework.context.support.GenericApplicationContext) testContext.getApplicationContext();</span>
            
<span class="fc" id="L187">            String beanName = annotation.dataSourceBeanName();</span>
            
            // Check if DataSource should replace existing bean
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">            if (annotation.replaceDataSource() &amp;&amp; context.containsBean(beanName)) {</span>
                // Remove existing bean definition
<span class="nc" id="L192">                context.removeBeanDefinition(beanName);</span>
<span class="nc" id="L193">                logger.debug(&quot;Replaced existing DataSource bean: {}&quot;, beanName);</span>
            }
            
            // Register MemGres DataSource
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            if (!context.containsBean(beanName)) {</span>
<span class="pc" id="L198">                context.registerBean(beanName, DataSource.class, () -&gt; dataSource);</span>
<span class="fc" id="L199">                logger.debug(&quot;Registered MemGres DataSource bean: {}&quot;, beanName);</span>
            }
            
            // Also register under standard DataSource name if requested
<span class="pc bpc" id="L203" title="3 of 6 branches missed.">            if (annotation.replaceDataSource() &amp;&amp; !beanName.equals(&quot;dataSource&quot;) &amp;&amp; context.containsBean(&quot;dataSource&quot;)) {</span>
<span class="nc" id="L204">                context.removeBeanDefinition(&quot;dataSource&quot;);</span>
<span class="nc" id="L205">                context.registerBean(&quot;dataSource&quot;, DataSource.class, () -&gt; dataSource);</span>
<span class="nc" id="L206">                logger.debug(&quot;Replaced primary DataSource bean with MemGres DataSource&quot;);</span>
<span class="pc bpc" id="L207" title="2 of 4 branches missed.">            } else if (!beanName.equals(&quot;dataSource&quot;) &amp;&amp; !context.containsBean(&quot;dataSource&quot;)) {</span>
<span class="fc" id="L208">                context.registerBean(&quot;dataSource&quot;, DataSource.class, () -&gt; dataSource);</span>
<span class="fc" id="L209">                logger.debug(&quot;Registered MemGres DataSource as primary DataSource bean&quot;);</span>
            }
            
            // Register additional MemGres components for injection
<span class="fc" id="L213">            context.registerBean(&quot;memgresEngine&quot;, MemGresEngine.class, </span>
<span class="fc" id="L214">                () -&gt; (MemGresEngine) testContext.getAttribute(ENGINE_ATTR));</span>
<span class="fc" id="L215">            context.registerBean(&quot;sqlExecutionEngine&quot;, SqlExecutionEngine.class,</span>
<span class="fc" id="L216">                () -&gt; new SqlExecutionEngine((MemGresEngine) testContext.getAttribute(ENGINE_ATTR)));</span>
            
<span class="fc" id="L218">            logger.debug(&quot;Registered MemGres components in Spring ApplicationContext&quot;);</span>
<span class="fc" id="L219">        } else {</span>
<span class="nc" id="L220">            logger.warn(&quot;ApplicationContext is not GenericApplicationContext, cannot register DataSource bean dynamically&quot;);</span>
        }
<span class="fc" id="L222">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
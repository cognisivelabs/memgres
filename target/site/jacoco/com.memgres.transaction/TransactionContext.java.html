<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MemGres Core</a> &gt; <a href="index.source.html" class="el_package">com.memgres.transaction</a> &gt; <span class="el_source">TransactionContext.java</span></div><h1>TransactionContext.java</h1><pre class="source lang-java linenums">package com.memgres.transaction;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Thread-local transaction context for managing the current transaction in each thread.
 * This allows implicit transaction management without passing transaction objects around.
 */
public class TransactionContext {
<span class="fc" id="L11">    private static final Logger logger = LoggerFactory.getLogger(TransactionContext.class);</span>
    
<span class="fc" id="L13">    private static final ThreadLocal&lt;Transaction&gt; currentTransaction = new ThreadLocal&lt;&gt;();</span>
    
    /**
     * Private constructor to prevent instantiation
     */
    private TransactionContext() {
    }
    
    /**
     * Get the current transaction for this thread
     * @return the current transaction or null if none is set
     */
    public static Transaction getCurrentTransaction() {
<span class="fc" id="L26">        return currentTransaction.get();</span>
    }
    
    /**
     * Set the current transaction for this thread
     * @param transaction the transaction to set (null to clear)
     */
    public static void setCurrentTransaction(Transaction transaction) {
<span class="fc" id="L34">        Transaction previous = currentTransaction.get();</span>
        
<span class="fc bfc" id="L36" title="All 2 branches covered.">        if (transaction == null) {</span>
<span class="fc" id="L37">            currentTransaction.remove();</span>
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">            if (previous != null) {</span>
<span class="fc" id="L39">                logger.debug(&quot;Cleared transaction context for thread {} (was transaction {})&quot;, </span>
<span class="fc" id="L40">                           Thread.currentThread().getName(), previous.getId());</span>
            }
        } else {
<span class="fc" id="L43">            currentTransaction.set(transaction);</span>
<span class="fc" id="L44">            logger.debug(&quot;Set transaction context for thread {} to transaction {}&quot;, </span>
<span class="fc" id="L45">                       Thread.currentThread().getName(), transaction.getId());</span>
            
<span class="pc bpc" id="L47" title="3 of 4 branches missed.">            if (previous != null &amp;&amp; previous.getId() != transaction.getId()) {</span>
<span class="nc" id="L48">                logger.warn(&quot;Replaced transaction {} with transaction {} in thread {} - &quot; +</span>
                          &quot;previous transaction may be leaked&quot;, 
<span class="nc" id="L50">                          previous.getId(), transaction.getId(), Thread.currentThread().getName());</span>
            }
        }
<span class="fc" id="L53">    }</span>
    
    /**
     * Check if there is a current transaction for this thread
     * @return true if a transaction is set
     */
    public static boolean hasCurrentTransaction() {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        return currentTransaction.get() != null;</span>
    }
    
    /**
     * Get the current transaction ID for this thread
     * @return the current transaction ID or -1 if none is set
     */
    public static long getCurrentTransactionId() {
<span class="nc" id="L68">        Transaction transaction = currentTransaction.get();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        return transaction != null ? transaction.getId() : -1;</span>
    }
    
    /**
     * Check if the current transaction is active
     * @return true if there is an active transaction
     */
    public static boolean isCurrentTransactionActive() {
<span class="nc" id="L77">        Transaction transaction = currentTransaction.get();</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">        return transaction != null &amp;&amp; transaction.isActive();</span>
    }
    
    /**
     * Get the current transaction isolation level
     * @return the isolation level or null if no transaction is set
     */
    public static TransactionIsolationLevel getCurrentIsolationLevel() {
<span class="nc" id="L86">        Transaction transaction = currentTransaction.get();</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        return transaction != null ? transaction.getIsolationLevel() : null;</span>
    }
    
    /**
     * Execute a block of code with a specific transaction set as current
     * @param transaction the transaction to set as current
     * @param block the code to execute
     * @param &lt;T&gt; the return type
     * @return the result of the block
     * @throws Exception if the block throws an exception
     */
    public static &lt;T&gt; T executeWithTransaction(Transaction transaction, TransactionBlock&lt;T&gt; block) throws Exception {
<span class="nc" id="L99">        Transaction previous = getCurrentTransaction();</span>
        try {
<span class="nc" id="L101">            setCurrentTransaction(transaction);</span>
<span class="nc" id="L102">            return block.execute();</span>
        } finally {
<span class="nc" id="L104">            setCurrentTransaction(previous);</span>
        }
    }
    
    /**
     * Execute a block of code with no current transaction
     * @param block the code to execute
     * @param &lt;T&gt; the return type
     * @return the result of the block
     * @throws Exception if the block throws an exception
     */
    public static &lt;T&gt; T executeWithoutTransaction(TransactionBlock&lt;T&gt; block) throws Exception {
<span class="nc" id="L116">        return executeWithTransaction(null, block);</span>
    }
    
    /**
     * Clear the current transaction context
     * This should be called when a thread finishes to prevent memory leaks
     */
    public static void clearContext() {
<span class="nc" id="L124">        Transaction transaction = currentTransaction.get();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (transaction != null) {</span>
<span class="nc" id="L126">            currentTransaction.remove();</span>
<span class="nc" id="L127">            logger.debug(&quot;Cleared transaction context for thread {} (was transaction {})&quot;, </span>
<span class="nc" id="L128">                       Thread.currentThread().getName(), transaction.getId());</span>
        }
<span class="nc" id="L130">    }</span>
    
    /**
     * Get information about the current transaction context
     * @return a string describing the current context
     */
    public static String getContextInfo() {
<span class="nc" id="L137">        Transaction transaction = currentTransaction.get();</span>
<span class="nc" id="L138">        String threadName = Thread.currentThread().getName();</span>
        
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (transaction == null) {</span>
<span class="nc" id="L141">            return &quot;Thread '&quot; + threadName + &quot;': No transaction context&quot;;</span>
        } else {
<span class="nc" id="L143">            return String.format(&quot;Thread '%s': Transaction %d (%s, %s)&quot;, </span>
                               threadName, 
<span class="nc" id="L145">                               transaction.getId(), </span>
<span class="nc" id="L146">                               transaction.getState(), </span>
<span class="nc" id="L147">                               transaction.getIsolationLevel());</span>
        }
    }
    
    /**
     * Functional interface for transaction blocks
     * @param &lt;T&gt; the return type
     */
    @FunctionalInterface
    public interface TransactionBlock&lt;T&gt; {
        T execute() throws Exception;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
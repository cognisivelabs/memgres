<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MemGres Core</a> &gt; <a href="index.source.html" class="el_package">com.memgres.transaction</a> &gt; <span class="el_source">TransactionManager.java</span></div><h1>TransactionManager.java</h1><pre class="source lang-java linenums">package com.memgres.transaction;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicLong;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * Basic transaction manager for MemGres.
 * This is a simplified implementation that will be enhanced with full ACID properties.
 */
public class TransactionManager {
<span class="fc" id="L17">    private static final Logger logger = LoggerFactory.getLogger(TransactionManager.class);</span>
    
    private final AtomicLong transactionIdGenerator;
    private final ConcurrentMap&lt;Long, Transaction&gt; activeTransactions;
    private final ReadWriteLock managerLock;
    private volatile boolean shutdown;
    
<span class="fc" id="L24">    public TransactionManager() {</span>
<span class="fc" id="L25">        this.transactionIdGenerator = new AtomicLong(0);</span>
<span class="fc" id="L26">        this.activeTransactions = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L27">        this.managerLock = new ReentrantReadWriteLock();</span>
<span class="fc" id="L28">        this.shutdown = false;</span>
        
<span class="fc" id="L30">        logger.info(&quot;Transaction manager initialized&quot;);</span>
<span class="fc" id="L31">    }</span>
    
    /**
     * Begin a new transaction
     * @return the transaction object
     */
    public Transaction beginTransaction() {
<span class="fc" id="L38">        return beginTransaction(TransactionIsolationLevel.READ_COMMITTED);</span>
    }
    
    /**
     * Begin a new transaction with the specified isolation level
     * @param isolationLevel the isolation level
     * @return the transaction object
     */
    public Transaction beginTransaction(TransactionIsolationLevel isolationLevel) {
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        if (shutdown) {</span>
<span class="nc" id="L48">            throw new IllegalStateException(&quot;Transaction manager is shutdown&quot;);</span>
        }
        
<span class="fc" id="L51">        managerLock.readLock().lock();</span>
        try {
<span class="fc" id="L53">            long transactionId = transactionIdGenerator.incrementAndGet();</span>
<span class="fc" id="L54">            Transaction transaction = new Transaction(transactionId, isolationLevel, this);</span>
<span class="fc" id="L55">            activeTransactions.put(transactionId, transaction);</span>
            
<span class="fc" id="L57">            logger.debug(&quot;Started transaction {} with isolation level {}&quot;, </span>
<span class="fc" id="L58">                        transactionId, isolationLevel);</span>
            
<span class="fc" id="L60">            return transaction;</span>
        } finally {
<span class="fc" id="L62">            managerLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Commit a transaction
     * @param transaction the transaction to commit
     */
    public void commitTransaction(Transaction transaction) {
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (transaction == null) {</span>
<span class="nc" id="L72">            throw new IllegalArgumentException(&quot;Transaction cannot be null&quot;);</span>
        }
        
<span class="fc" id="L75">        Long transactionId = transaction.getId();</span>
<span class="fc" id="L76">        Transaction activeTransaction = activeTransactions.get(transactionId);</span>
        
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (activeTransaction == null) {</span>
<span class="nc" id="L79">            throw new IllegalStateException(&quot;Transaction not found or already completed: &quot; + transactionId);</span>
        }
        
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (activeTransaction != transaction) {</span>
<span class="nc" id="L83">            throw new IllegalStateException(&quot;Transaction object mismatch&quot;);</span>
        }
        
<span class="fc" id="L86">        managerLock.readLock().lock();</span>
        try {
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">            if (shutdown) {</span>
<span class="nc" id="L89">                throw new IllegalStateException(&quot;Transaction manager is shutdown&quot;);</span>
            }
            
<span class="fc" id="L92">            transaction.commit();</span>
<span class="fc" id="L93">            activeTransactions.remove(transactionId);</span>
            
<span class="fc" id="L95">            logger.debug(&quot;Committed transaction {}&quot;, transactionId);</span>
<span class="nc" id="L96">        } catch (Exception e) {</span>
<span class="nc" id="L97">            logger.error(&quot;Failed to commit transaction {}&quot;, transactionId, e);</span>
<span class="nc" id="L98">            rollbackTransaction(transaction);</span>
<span class="nc" id="L99">            throw new RuntimeException(&quot;Transaction commit failed&quot;, e);</span>
        } finally {
<span class="fc" id="L101">            managerLock.readLock().unlock();</span>
        }
<span class="fc" id="L103">    }</span>
    
    /**
     * Rollback a transaction
     * @param transaction the transaction to rollback
     */
    public void rollbackTransaction(Transaction transaction) {
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (transaction == null) {</span>
<span class="nc" id="L111">            throw new IllegalArgumentException(&quot;Transaction cannot be null&quot;);</span>
        }
        
<span class="fc" id="L114">        Long transactionId = transaction.getId();</span>
<span class="fc" id="L115">        Transaction activeTransaction = activeTransactions.get(transactionId);</span>
        
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (activeTransaction == null) {</span>
<span class="nc" id="L118">            logger.warn(&quot;Transaction not found or already completed: {}&quot;, transactionId);</span>
<span class="nc" id="L119">            return;</span>
        }
        
<span class="fc" id="L122">        managerLock.readLock().lock();</span>
        try {
<span class="fc" id="L124">            transaction.rollback();</span>
<span class="fc" id="L125">            activeTransactions.remove(transactionId);</span>
            
<span class="fc" id="L127">            logger.debug(&quot;Rolled back transaction {}&quot;, transactionId);</span>
<span class="nc" id="L128">        } catch (Exception e) {</span>
<span class="nc" id="L129">            logger.error(&quot;Failed to rollback transaction {}&quot;, transactionId, e);</span>
            // Remove from active transactions even if rollback fails
<span class="nc" id="L131">            activeTransactions.remove(transactionId);</span>
        } finally {
<span class="fc" id="L133">            managerLock.readLock().unlock();</span>
        }
<span class="fc" id="L135">    }</span>
    
    /**
     * Get an active transaction by ID
     * @param transactionId the transaction ID
     * @return the transaction or null if not found
     */
    public Transaction getTransaction(long transactionId) {
<span class="nc" id="L143">        managerLock.readLock().lock();</span>
        try {
<span class="nc" id="L145">            return activeTransactions.get(transactionId);</span>
        } finally {
<span class="nc" id="L147">            managerLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Get the number of active transactions
     * @return the number of active transactions
     */
    public int getActiveTransactionCount() {
<span class="nc" id="L156">        managerLock.readLock().lock();</span>
        try {
<span class="nc" id="L158">            return activeTransactions.size();</span>
        } finally {
<span class="nc" id="L160">            managerLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Check if a transaction is active
     * @param transactionId the transaction ID
     * @return true if the transaction is active
     */
    public boolean isTransactionActive(long transactionId) {
<span class="nc" id="L170">        managerLock.readLock().lock();</span>
        try {
<span class="nc" id="L172">            return activeTransactions.containsKey(transactionId);</span>
        } finally {
<span class="nc" id="L174">            managerLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Get the current thread's transaction, if any
     * @return the current transaction or null
     */
    public Transaction getCurrentTransaction() {
<span class="nc" id="L183">        return TransactionContext.getCurrentTransaction();</span>
    }
    
    /**
     * Set the current thread's transaction
     * @param transaction the transaction to set (null to clear)
     */
    public void setCurrentTransaction(Transaction transaction) {
<span class="fc" id="L191">        TransactionContext.setCurrentTransaction(transaction);</span>
<span class="fc" id="L192">    }</span>
    
    /**
     * Execute a block of code within a transaction
     * @param block the code to execute
     * @param &lt;T&gt; the return type
     * @return the result of the block
     * @throws Exception if the block throws an exception
     */
    public &lt;T&gt; T executeInTransaction(TransactionBlock&lt;T&gt; block) throws Exception {
<span class="nc" id="L202">        return executeInTransaction(block, TransactionIsolationLevel.READ_COMMITTED);</span>
    }
    
    /**
     * Execute a block of code within a transaction with specified isolation level
     * @param block the code to execute
     * @param isolationLevel the isolation level
     * @param &lt;T&gt; the return type
     * @return the result of the block
     * @throws Exception if the block throws an exception
     */
    public &lt;T&gt; T executeInTransaction(TransactionBlock&lt;T&gt; block, 
                                     TransactionIsolationLevel isolationLevel) throws Exception {
<span class="nc" id="L215">        Transaction transaction = beginTransaction(isolationLevel);</span>
<span class="nc" id="L216">        Transaction previousTransaction = getCurrentTransaction();</span>
        
        try {
<span class="nc" id="L219">            setCurrentTransaction(transaction);</span>
<span class="nc" id="L220">            T result = block.execute();</span>
<span class="nc" id="L221">            commitTransaction(transaction);</span>
<span class="nc" id="L222">            return result;</span>
<span class="nc" id="L223">        } catch (Exception e) {</span>
<span class="nc" id="L224">            rollbackTransaction(transaction);</span>
<span class="nc" id="L225">            throw e;</span>
        } finally {
<span class="nc" id="L227">            setCurrentTransaction(previousTransaction);</span>
        }
    }
    
    /**
     * Shutdown the transaction manager
     */
    public void shutdown() {
<span class="fc" id="L235">        managerLock.writeLock().lock();</span>
        try {
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">            if (shutdown) {</span>
<span class="nc" id="L238">                return;</span>
            }
            
<span class="fc" id="L241">            logger.info(&quot;Shutting down transaction manager with {} active transactions&quot;, </span>
<span class="fc" id="L242">                       activeTransactions.size());</span>
            
            // Rollback all active transactions
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">            for (Transaction transaction : activeTransactions.values()) {</span>
                try {
<span class="nc" id="L247">                    transaction.rollback();</span>
<span class="nc" id="L248">                } catch (Exception e) {</span>
<span class="nc" id="L249">                    logger.error(&quot;Failed to rollback transaction {} during shutdown&quot;, </span>
<span class="nc" id="L250">                               transaction.getId(), e);</span>
<span class="nc" id="L251">                }</span>
<span class="nc" id="L252">            }</span>
            
<span class="fc" id="L254">            activeTransactions.clear();</span>
<span class="fc" id="L255">            shutdown = true;</span>
            
<span class="fc" id="L257">            logger.info(&quot;Transaction manager shutdown complete&quot;);</span>
        } finally {
<span class="fc" id="L259">            managerLock.writeLock().unlock();</span>
        }
<span class="fc" id="L261">    }</span>
    
    /**
     * Check if the transaction manager is shutdown
     * @return true if shutdown
     */
    public boolean isShutdown() {
<span class="nc" id="L268">        managerLock.readLock().lock();</span>
        try {
<span class="nc" id="L270">            return shutdown;</span>
        } finally {
<span class="nc" id="L272">            managerLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Functional interface for transaction blocks
     * @param &lt;T&gt; the return type
     */
    @FunctionalInterface
    public interface TransactionBlock&lt;T&gt; {
        T execute() throws Exception;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
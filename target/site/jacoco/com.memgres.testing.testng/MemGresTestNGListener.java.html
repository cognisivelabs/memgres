<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MemGresTestNGListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MemGres Core</a> &gt; <a href="index.source.html" class="el_package">com.memgres.testing.testng</a> &gt; <span class="el_source">MemGresTestNGListener.java</span></div><h1>MemGresTestNGListener.java</h1><pre class="source lang-java linenums">package com.memgres.testing.testng;

import com.memgres.core.MemGresEngine;
import com.memgres.testing.MemGres;
import com.memgres.testing.MemGresTestHelper;
import com.memgres.transaction.Transaction;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.testng.*;

import java.lang.reflect.Method;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

/**
 * TestNG listener for MemGres database integration.
 * 
 * &lt;p&gt;This listener automatically manages the lifecycle of MemGres database instances
 * for tests annotated with {@link MemGres}. It provides:&lt;/p&gt;
 * &lt;ul&gt;
 *   &lt;li&gt;Automatic database startup and shutdown&lt;/li&gt;
 *   &lt;li&gt;Schema creation and initialization&lt;/li&gt;
 *   &lt;li&gt;SQL script execution&lt;/li&gt;
 *   &lt;li&gt;Transaction management with rollback support&lt;/li&gt;
 *   &lt;li&gt;Test isolation&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt;To use this listener, add it to your TestNG configuration:&lt;/p&gt;
 * &lt;pre&gt;{@code
 * @Listeners(MemGresTestNGListener.class)
 * public class MyTest {
 *     @MemGres
 *     @Test
 *     public void testWithMemGres() {
 *         // Test implementation
 *     }
 * }
 * }&lt;/pre&gt;
 * 
 * @since 1.0.0
 */
<span class="fc" id="L42">public class MemGresTestNGListener implements ITestListener, IInvokedMethodListener {</span>
    
<span class="fc" id="L44">    private static final Logger logger = LoggerFactory.getLogger(MemGresTestNGListener.class);</span>
    
<span class="fc" id="L46">    private final ConcurrentMap&lt;String, MemGresEngine&gt; classEngines = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L47">    private final ConcurrentMap&lt;String, MemGresTestHelper&gt; classHelpers = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L48">    private final ConcurrentMap&lt;String, MemGresTestHelper.MemGresConfig&gt; classConfigs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L49">    private final ConcurrentMap&lt;String, Transaction&gt; methodTransactions = new ConcurrentHashMap&lt;&gt;();</span>
    
    @Override
    public void onStart(ITestContext context) {
<span class="fc" id="L53">        logger.debug(&quot;Starting TestNG test context: {}&quot;, context.getName());</span>
<span class="fc" id="L54">    }</span>
    
    @Override
    public void onFinish(ITestContext context) {
<span class="fc" id="L58">        logger.debug(&quot;Finishing TestNG test context: {}&quot;, context.getName());</span>
        // Clean up any remaining class-level engines
<span class="fc" id="L60">        classEngines.forEach((className, engine) -&gt; {</span>
<span class="nc" id="L61">            MemGresTestHelper helper = classHelpers.get(className);</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">            if (helper != null &amp;&amp; engine != null) {</span>
                try {
<span class="nc" id="L64">                    helper.shutdownEngine(engine);</span>
<span class="nc" id="L65">                    logger.debug(&quot;Shutdown class-level MemGres database for: {}&quot;, className);</span>
<span class="nc" id="L66">                } catch (Exception e) {</span>
<span class="nc" id="L67">                    logger.error(&quot;Error shutting down class-level MemGres database for: &quot; + className, e);</span>
<span class="nc" id="L68">                }</span>
            }
<span class="nc" id="L70">        });</span>
<span class="fc" id="L71">        classEngines.clear();</span>
<span class="fc" id="L72">        classHelpers.clear();</span>
<span class="fc" id="L73">        classConfigs.clear();</span>
<span class="fc" id="L74">    }</span>
    
    @Override
    public void onTestStart(ITestResult result) {
<span class="fc" id="L78">        Method method = result.getMethod().getConstructorOrMethod().getMethod();</span>
<span class="fc" id="L79">        Class&lt;?&gt; testClass = result.getTestClass().getRealClass();</span>
        
<span class="fc" id="L81">        MemGres annotation = findMemGresAnnotation(method, testClass);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (annotation == null) {</span>
<span class="nc" id="L83">            return;</span>
        }
        
        try {
<span class="fc" id="L87">            MemGresEngine engine = getOrCreateEngine(testClass, annotation);</span>
<span class="fc" id="L88">            MemGresTestHelper helper = getOrCreateHelper(testClass);</span>
<span class="fc" id="L89">            MemGresTestHelper.MemGresConfig config = getOrCreateConfig(testClass, annotation);</span>
            
            // Start transaction for ALL tests to maintain data consistency within a test method
            // For non-transactional tests, this ensures INSERT/SELECT operations see each other's data
            // For transactional tests, this will be rolled back after the test
<span class="fc" id="L94">            Transaction transaction = engine.getTransactionManager()</span>
<span class="fc" id="L95">                    .beginTransaction(com.memgres.transaction.TransactionIsolationLevel.READ_COMMITTED);</span>
            
<span class="fc" id="L97">            String testKey = getTestKey(result);</span>
<span class="fc" id="L98">            methodTransactions.put(testKey, transaction);</span>
            
            // Set the transaction in the thread-local context so SqlExecutionEngine can use it
<span class="fc" id="L101">            engine.getTransactionManager().setCurrentTransaction(transaction);</span>
            
            // Store engine reference for parameter injection (legacy)
<span class="fc" id="L104">            result.setAttribute(&quot;memgres.engine&quot;, engine);</span>
<span class="fc" id="L105">            result.setAttribute(&quot;memgres.helper&quot;, helper);</span>
<span class="fc" id="L106">            result.setAttribute(&quot;memgres.config&quot;, config);</span>
            
            // Set thread-local components for parameter-free access
<span class="fc" id="L109">            MemGresTestNGConfigurationProvider.setCurrentTestComponents(engine, helper, config);</span>
            
<span class="fc" id="L111">            logger.debug(&quot;Started transaction for TestNG test method: {} (transactional={})&quot;, </span>
<span class="fc" id="L112">                        method.getName(), config.isTransactional());</span>
            
<span class="nc" id="L114">        } catch (Exception e) {</span>
<span class="nc" id="L115">            logger.error(&quot;Error setting up MemGres for test: &quot; + method.getName(), e);</span>
<span class="nc" id="L116">            throw new RuntimeException(&quot;Failed to setup MemGres database&quot;, e);</span>
<span class="fc" id="L117">        }</span>
<span class="fc" id="L118">    }</span>
    
    @Override
    public void onTestSuccess(ITestResult result) {
<span class="fc" id="L122">        handleTestFinish(result);</span>
<span class="fc" id="L123">    }</span>
    
    @Override
    public void onTestFailure(ITestResult result) {
<span class="nc" id="L127">        handleTestFinish(result);</span>
<span class="nc" id="L128">    }</span>
    
    @Override
    public void onTestSkipped(ITestResult result) {
<span class="nc" id="L132">        handleTestFinish(result);</span>
<span class="nc" id="L133">    }</span>
    
    private void handleTestFinish(ITestResult result) {
<span class="fc" id="L136">        Method method = result.getMethod().getConstructorOrMethod().getMethod();</span>
<span class="fc" id="L137">        Class&lt;?&gt; testClass = result.getTestClass().getRealClass();</span>
        
<span class="fc" id="L139">        MemGres annotation = findMemGresAnnotation(method, testClass);</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (annotation == null) {</span>
<span class="nc" id="L141">            return;</span>
        }
        
        try {
<span class="fc" id="L145">            MemGresEngine engine = (MemGresEngine) result.getAttribute(&quot;memgres.engine&quot;);</span>
<span class="fc" id="L146">            MemGresTestHelper helper = (MemGresTestHelper) result.getAttribute(&quot;memgres.helper&quot;);</span>
<span class="fc" id="L147">            MemGresTestHelper.MemGresConfig config = (MemGresTestHelper.MemGresConfig) result.getAttribute(&quot;memgres.config&quot;);</span>
            
<span class="fc" id="L149">            String testKey = getTestKey(result);</span>
<span class="fc" id="L150">            Transaction transaction = methodTransactions.remove(testKey);</span>
            
            // Handle transaction cleanup
<span class="pc bpc" id="L153" title="4 of 8 branches missed.">            if (helper != null &amp;&amp; config != null &amp;&amp; transaction != null &amp;&amp; engine != null) {</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                if (config.isTransactional()) {</span>
                    // For transactional tests, rollback to undo changes
<span class="nc" id="L156">                    helper.rollbackTransactionIfNeeded(engine, transaction, config);</span>
<span class="nc" id="L157">                    logger.debug(&quot;Rolled back transaction for transactional TestNG test method: {}&quot;, method.getName());</span>
                } else {
                    // For non-transactional tests, commit the changes
<span class="fc" id="L160">                    engine.getTransactionManager().commitTransaction(transaction);</span>
<span class="fc" id="L161">                    logger.debug(&quot;Committed transaction for non-transactional TestNG test method: {}&quot;, method.getName());</span>
                }
                
                // Clear the transaction context
<span class="fc" id="L165">                engine.getTransactionManager().setCurrentTransaction(null);</span>
                
                // Clear thread-local components
<span class="fc" id="L168">                MemGresTestNGConfigurationProvider.clearCurrentTestComponents();</span>
            }
            
            // Clean up method-level engines
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">            if (!isClassLevelAnnotation(testClass)) {</span>
<span class="pc bpc" id="L173" title="2 of 4 branches missed.">                if (engine != null &amp;&amp; helper != null) {</span>
<span class="fc" id="L174">                    helper.shutdownEngine(engine);</span>
<span class="fc" id="L175">                    logger.debug(&quot;Shutdown method-level MemGres database for TestNG: {}&quot;, method.getName());</span>
                }
            }
            
<span class="nc" id="L179">        } catch (Exception e) {</span>
<span class="nc" id="L180">            logger.error(&quot;Error cleaning up MemGres for test: &quot; + method.getName(), e);</span>
<span class="fc" id="L181">        }</span>
<span class="fc" id="L182">    }</span>
    
    private MemGres findMemGresAnnotation(Method method, Class&lt;?&gt; testClass) {
        // Check method-level annotation first
<span class="fc" id="L186">        MemGres methodAnnotation = method.getAnnotation(MemGres.class);</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (methodAnnotation != null) {</span>
<span class="fc" id="L188">            return methodAnnotation;</span>
        }
        
        // Check class-level annotation
<span class="nc" id="L192">        return testClass.getAnnotation(MemGres.class);</span>
    }
    
    private boolean isClassLevelAnnotation(Class&lt;?&gt; testClass) {
<span class="fc" id="L196">        return testClass.isAnnotationPresent(MemGres.class);</span>
    }
    
    private MemGresEngine getOrCreateEngine(Class&lt;?&gt; testClass, MemGres annotation) throws Exception {
        // Check if class-level engine exists
<span class="fc" id="L201">        String className = testClass.getName();</span>
<span class="fc" id="L202">        MemGresEngine engine = classEngines.get(className);</span>
        
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (engine != null) {</span>
<span class="nc" id="L205">            return engine;</span>
        }
        
        // Create new engine
<span class="fc" id="L209">        MemGresTestHelper helper = getOrCreateHelper(testClass);</span>
<span class="fc" id="L210">        MemGresTestHelper.MemGresConfig config = MemGresTestHelper.MemGresConfig.fromAnnotation(annotation);</span>
<span class="fc" id="L211">        engine = helper.createEngine(config);</span>
        
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (isClassLevelAnnotation(testClass)) {</span>
            // Store class-level engine for reuse
<span class="nc" id="L215">            classEngines.put(className, engine);</span>
        }
        
<span class="fc" id="L218">        logger.debug(&quot;Created MemGres database for TestNG class: {}&quot;, className);</span>
        
<span class="fc" id="L220">        return engine;</span>
    }
    
    private MemGresTestHelper getOrCreateHelper(Class&lt;?&gt; testClass) {
<span class="fc" id="L224">        String className = testClass.getName();</span>
<span class="fc" id="L225">        return classHelpers.computeIfAbsent(className, k -&gt; new MemGresTestHelper());</span>
    }
    
    private MemGresTestHelper.MemGresConfig getOrCreateConfig(Class&lt;?&gt; testClass, MemGres annotation) {
<span class="fc" id="L229">        String className = testClass.getName();</span>
<span class="fc" id="L230">        return classConfigs.computeIfAbsent(className, k -&gt; MemGresTestHelper.MemGresConfig.fromAnnotation(annotation));</span>
    }
    
    private String getTestKey(ITestResult result) {
<span class="fc" id="L234">        return result.getTestClass().getName() + &quot;.&quot; + result.getMethod().getMethodName() + </span>
<span class="fc" id="L235">               &quot;[&quot; + java.util.Arrays.toString(result.getParameters()) + &quot;]&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>